# GitHub Copilot Instructions for KmiDi (staging)

- This repo is the final staging sandbox for testing training configurations, project organization, and integration flows. Treat it as a mirror/playground; avoid making assumptions that it is the single canonical monorepo.
- Philosophy: "Interrogate Before Generate"; every rule break needs an emotional justification; human imperfection (timing/pitch drift) is a feature (see [CLAUDE.md](CLAUDE.md)).
- Pillars mirrored here: [music_brain/](music_brain/) (Python intent + production intelligence), [penta_core/](include/penta/) and [src_penta-core/](src_penta-core/) (C++ RT engines), [iDAW_Core/](iDAW_Core/) (JUCE plugins), [mcp_workstation/](mcp_workstation/) and [mcp_todo/](mcp_todo/) (multi-AI orchestration), desktop shell in [src-tauri/](src-tauri/) + web UI in [web/](web/).
- Architecture in one line: Side A (C++ real-time, lock-free, no allocs) ↔ ring buffer ↔ Side B (Python AI + UI); emotional intent feeds production rules (see [DESIGN_Integration_Architecture.md](DESIGN_Integration_Architecture.md)).
- Core Python patterns (music_brain): dataclasses + enums with `to_dict()/from_dict()`, lazy imports for CLI speed, intent schema phases 0–2, rule-breaking enums and teaching helpers live in [music_brain/session](music_brain/session/); production mapping and humanization logic in [music_brain/emotion/emotion_production.py](music_brain/emotion/emotion_production.py) and [music_brain/groove](music_brain/groove/).
- C++ rules: RT-safe audio callbacks are `noexcept`, avoid heap on audio thread, prefer `std::pmr` arenas, AVX2 SIMD with scalar fallback (see [include/penta](include/penta/) and [benchmarks/](benchmarks/)).
- Desktop flow (Kelly app): React/Vite → Tauri commands → HTTP to Music Brain API at 127.0.0.1:8000; commands map to `/emotions`, `/generate`, `/interrogate` (see [README.md](README.md)).
- CLI quick refs: `python -m mcp_workstation status`, `python -m mcp_todo.cli list`, `daiw intent suggest grief`, `daiw diagnose "F-C-Am-Dm"` (Python package entry in [music_brain/cli.py](music_brain/cli.py)).
- Installs: `pip install -e .` then optionally `pip install -e ".[dev]"`; Tauri/web needs `npm install`; C++ builds use CMake+Ninja (`mkdir build && cd build && cmake .. -G Ninja && ninja penta_core && ctest --output-on-failure`).
- Tests: Python suites under [tests](tests/) and [music_brain/tests](music_brain/tests/) via `pytest -v`; C++ via `ctest`; Tauri smoke via `npm run tauri dev`; keep line length 100, format with `black`, lint/typecheck with `flake8`/`mypy`.
- Data + guides: production/groove rules encoded from guides in [vault/](vault/) and referenced by mapper/humanizer modules; chord/intent vocab in [data](data/) and [Theory_Reference/](Theory_Reference/).
- Build variants live in [config](config/) (dev-mac, train-nvidia, prod-aws); pick the config before suggesting performance-sensitive defaults (see [BUILD_VARIANTS.md](BUILD_VARIANTS.md)).
- When extending features: add new grooves in [music_brain/groove/templates.py](music_brain/groove/templates.py) + genre maps in [data](data/); new rule-break enums go in [music_brain/session/intent_schema.py](music_brain/session/intent_schema.py) with justification text and teacher updates.
- MCP orchestration: proposals/workflows in [mcp_workstation](mcp_workstation/) (orchestrator, phases, proposals); TODO sync lives in [mcp_todo](mcp_todo/); respect cross-AI task model when generating tasks.
- C++/Python bridging: bindings in [bindings](bindings/) and [python/penta_core](python/penta_core/); maintain API parity with core headers and avoid breaking RT-safety when exposing new calls.
- Frontend style: Vite+Tailwind in [web](web/) and Tauri UI in [src-tauri](src-tauri/); keep API targets at localhost:8000 unless configs say otherwise; prefer hooks over ad-hoc fetches (see `useMusicBrain` in web/src).
- Troubleshooting first checks: verify Music Brain API up (`curl http://127.0.0.1:8000/emotions`), ensure build config matches hardware, and confirm no allocations on audio paths.
- Always tie musical changes to emotional intent (ask for the "why"), and prefer humanization over perfect quantization by default.
